import * as XLSX from 'xlsx';
import { MedicalData, Guardian } from '../types';

// ุฅูุดุงุก ูุงูุจ Excel ููุจูุงูุงุช ุงููุฑุถูุฉ
export const createMedicalDataTemplate = (guardians: Guardian[]) => {
  const templateData = [
    {
      'ุงุณู ุงููุฑูุถ': 'ูุซุงู: ุฃุญูุฏ ูุญูุฏ ุงูุณุงูู',
      'ุฑูู ูููุฉ ุงููุฑูุถ': '123456789',
      'ุฑูู ูููุฉ ููู ุงูุฃูุฑ': guardians[0]?.nationalId || '123456789',
      'ููุน ุงููุฑุถ': 'ูุฑุถ ูุฒูู',
      'ุฑูู ุงูุฌูุงู': '0597123456',
      'ููุงุญุธุงุช': 'ููุงุญุธุงุช ุฅุถุงููุฉ'
    }
  ];

  // ุฅูุดุงุก ูุฑูุฉ ุงูุนูู
  const worksheet = XLSX.utils.json_to_sheet(templateData);

  // ุชุนููู ุงุชุฌุงู RTL ูููุฑูุฉ
  worksheet['!dir'] = 'rtl';

  // ุชุนููู ุนุฑุถ ุงูุฃุนูุฏุฉ
  const columnWidths = [
    { wch: 25 }, // ุงุณู ุงููุฑูุถ
    { wch: 20 }, // ุฑูู ูููุฉ ุงููุฑูุถ
    { wch: 20 }, // ุฑูู ูููุฉ ููู ุงูุฃูุฑ
    { wch: 20 }, // ููุน ุงููุฑุถ
    { wch: 15 }, // ุฑูู ุงูุฌูุงู
    { wch: 30 }  // ููุงุญุธุงุช
  ];
  worksheet['!cols'] = columnWidths;

  // ุฅูุดุงุก ูุฑูุฉ ุฃูููุงุก ุงูุฃููุฑ ุงููุชุงุญูู
  const guardiansData = guardians.map(guardian => ({
    'ุฑูู ููู ุงูุฃูุฑ': guardian.id,
    'ุงุณู ููู ุงูุฃูุฑ': guardian.name,
    'ุฑูู ูููุฉ ููู ุงูุฃูุฑ': guardian.nationalId,
    'ุฑูู ุงููุงุชู': guardian.phone,
    'ุงูููุทูุฉ': guardian.area?.name || 'ุบูุฑ ูุญุฏุฏ',
    'ุงูุญุงูุฉ ุงูุงุฌุชูุงุนูุฉ': guardian.maritalStatus,
    'ุญุงูุฉ ุงูุฅูุงูุฉ': guardian.residenceStatus === 'displaced' ? 'ูุงุฒุญ' : 'ูููู'
  }));

  const guardiansWorksheet = XLSX.utils.json_to_sheet(guardiansData);
  guardiansWorksheet['!dir'] = 'rtl';
  guardiansWorksheet['!cols'] = [
    { wch: 15 }, // ุฑูู ููู ุงูุฃูุฑ
    { wch: 25 }, // ุงุณู ููู ุงูุฃูุฑ
    { wch: 20 }, // ุฑูู ูููุฉ ููู ุงูุฃูุฑ
    { wch: 15 }, // ุฑูู ุงููุงุชู
    { wch: 20 }, // ุงูููุทูุฉ
    { wch: 18 }, // ุงูุญุงูุฉ ุงูุงุฌุชูุงุนูุฉ
    { wch: 15 }  // ุญุงูุฉ ุงูุฅูุงูุฉ
  ];

  // ุฅูุดุงุก ูุฑูุฉ ุฃููุงุน ุงูุฃูุฑุงุถ
  const diseaseTypesData = [
    { 'ููุน ุงููุฑุถ': 'ูุฑุถ ูุฒูู', 'ุงููุตู': 'ุฃูุฑุงุถ ูุฒููุฉ ูุชููุนุฉ' },
    { 'ููุน ุงููุฑุถ': 'ูุฑุถ ููุจ', 'ุงููุตู': 'ุฃูุฑุงุถ ุงูููุจ ูุงูุฃูุนูุฉ ุงูุฏูููุฉ' },
    { 'ููุน ุงููุฑุถ': 'ูุฑุถ ุงูุฑุจู', 'ุงููุตู': 'ุงูุฑุจู ูุฃูุฑุงุถ ุงูุฌูุงุฒ ุงูุชููุณู' },
    { 'ููุน ุงููุฑุถ': 'ูุฑุถ ุงูุตุฑุน', 'ุงููุตู': 'ุงูุตุฑุน ูุฃูุฑุงุถ ุงูุฃุนุตุงุจ' },
    { 'ููุน ุงููุฑุถ': 'ูุฑุถ ุงูุณูุฑู', 'ุงููุตู': 'ุฏุงุก ุงูุณูุฑู ุจุฃููุงุนู' },
    { 'ููุน ุงููุฑุถ': 'ูุฑุถ ุงูููู', 'ุงููุตู': 'ุฃูุฑุงุถ ุงูููู ูุงููุณุงูู ุงูุจูููุฉ' },
    { 'ููุน ุงููุฑุถ': 'ูุฑุถ ุงูุถุบุท', 'ุงููุตู': 'ุงุฑุชูุงุน ุถุบุท ุงูุฏู' },
    { 'ููุน ุงููุฑุถ': 'ูุฑุถ ุงูุบุฏุฉ ุงูุฏุฑููุฉ', 'ุงููุตู': 'ุงุถุทุฑุงุจุงุช ุงูุบุฏุฉ ุงูุฏุฑููุฉ' },
    { 'ููุน ุงููุฑุถ': 'ูุฑุถ ุงููุจุฏ', 'ุงููุตู': 'ุฃูุฑุงุถ ุงููุจุฏ' },
    { 'ููุน ุงููุฑุถ': 'ูุฑุถ ุงูุณุฑุทุงู', 'ุงููุตู': 'ุงูุฃูุฑุงู ุงูุณุฑุทุงููุฉ' },
    { 'ููุน ุงููุฑุถ': 'ูุฑุถ ุงูุฌูุงุฒ ุงููุถูู', 'ุงููุตู': 'ุฃูุฑุงุถ ุงููุนุฏุฉ ูุงูุฃูุนุงุก' },
    { 'ููุน ุงููุฑุถ': 'ูุฑุถ ุงูุฌูุงุฒ ุงูุชููุณู', 'ุงููุตู': 'ุฃูุฑุงุถ ุงูุฑุฆุฉ ูุงูุฌูุงุฒ ุงูุชููุณู' },
    { 'ููุน ุงููุฑุถ': 'ูุฑุถ ุงูุนุธุงู', 'ุงููุตู': 'ุฃูุฑุงุถ ุงูุนุธุงู ูุงูููุงุตู' },
    { 'ููุน ุงููุฑุถ': 'ูุฑุถ ุงูุนููู', 'ุงููุตู': 'ุฃูุฑุงุถ ุงูุนููู' },
    { 'ููุน ุงููุฑุถ': 'ูุฑุถ ุงูุฃุนุตุงุจ', 'ุงููุตู': 'ุฃูุฑุงุถ ุงูุฌูุงุฒ ุงูุนุตุจู' },
    { 'ููุน ุงููุฑุถ': 'ูุฑุถ ููุณู', 'ุงููุตู': 'ุงูุงุถุทุฑุงุจุงุช ุงูููุณูุฉ' },
    { 'ููุน ุงููุฑุถ': 'ูุฑุถ ุฌูุฏู', 'ุงููุตู': 'ุฃูุฑุงุถ ุงูุฌูุฏ' },
    { 'ููุน ุงููุฑุถ': 'ูุฑุถ ุขุฎุฑ', 'ุงููุตู': 'ุฃูุฑุงุถ ุฃุฎุฑู ุบูุฑ ูุตููุฉ' }
  ];

  const diseaseTypesWorksheet = XLSX.utils.json_to_sheet(diseaseTypesData);
  diseaseTypesWorksheet['!dir'] = 'rtl';
  diseaseTypesWorksheet['!cols'] = [
    { wch: 25 }, // ููุน ุงููุฑุถ
    { wch: 40 }  // ุงููุตู
  ];

  // ุฅูุดุงุก ูุฑูุฉ ุงูุชุนูููุงุช
  const instructionsData = [
    { 'ุงูุชุนูููุงุช': '๐ ููุงุญุธุงุช ูููุฉ ูููุก ุงูุจูุงูุงุช ุงููุฑุถูุฉ:' },
    { 'ุงูุชุนูููุงุช': '' },
    { 'ุงูุชุนูููุงุช': 'โ ุงูุญููู ุงููุทููุจุฉ:' },
    { 'ุงูุชุนูููุงุช': '1. ุงุณู ุงููุฑูุถ (ูุทููุจ)' },
    { 'ุงูุชุนูููุงุช': '2. ุฑูู ูููุฉ ุงููุฑูุถ (ูุทููุจ)' },
    { 'ุงูุชุนูููุงุช': '3. ุฑูู ูููุฉ ููู ุงูุฃูุฑ (ูุทููุจ)' },
    { 'ุงูุชุนูููุงุช': '4. ููุน ุงููุฑุถ (ูุทููุจ)' },
    { 'ุงูุชุนูููุงุช': '5. ุฑูู ุงูุฌูุงู (ูุทููุจ)' },
    { 'ุงูุชุนูููุงุช': '6. ุงูููุงุญุธุงุช (ุงุฎุชูุงุฑู)' },
    { 'ุงูุชุนูููุงุช': '' },
    { 'ุงูุชุนูููุงุช': '๐ฅ ุฃููุงุน ุงูุฃูุฑุงุถ ุงููุชุงุญุฉ:' },
    { 'ุงูุชุนูููุงุช': 'โข ูุฑุถ ูุฒููุ ูุฑุถ ููุจุ ูุฑุถ ุงูุฑุจูุ ูุฑุถ ุงูุตุฑุน' },
    { 'ุงูุชุนูููุงุช': 'โข ูุฑุถ ุงูุณูุฑูุ ูุฑุถ ุงููููุ ูุฑุถ ุงูุถุบุทุ ูุฑุถ ุงูุบุฏุฉ ุงูุฏุฑููุฉ' },
    { 'ุงูุชุนูููุงุช': 'โข ูุฑุถ ุงููุจุฏุ ูุฑุถ ุงูุณุฑุทุงูุ ูุฑุถ ุงูุฌูุงุฒ ุงููุถููุ ูุฑุถ ุงูุฌูุงุฒ ุงูุชููุณู' },
    { 'ุงูุชุนูููุงุช': 'โข ูุฑุถ ุงูุนุธุงูุ ูุฑุถ ุงูุนูููุ ูุฑุถ ุงูุฃุนุตุงุจุ ูุฑุถ ููุณูุ ูุฑุถ ุฌูุฏูุ ูุฑุถ ุขุฎุฑ' },
    { 'ุงูุชุนูููุงุช': 'โข ุฑุงุฌุน ูุฑูุฉ "ุฃููุงุน ุงูุฃูุฑุงุถ" ููุชูุงุตูู' },
    { 'ุงูุชุนูููุงุช': '' },
    { 'ุงูุชุนูููุงุช': '๐จโ๐ฉโ๐งโ๐ฆ ุดุฑูุท ููู ุงูุฃูุฑ:' },
    { 'ุงูุชุนูููุงุช': 'โข ุฑูู ูููุฉ ููู ุงูุฃูุฑ ูุฌุจ ุฃู ูููู ููุฌูุฏ ูู ุงููุธุงู' },
    { 'ุงูุชุนูููุงุช': 'โข ุฑุงุฌุน ูุฑูุฉ "ุฃูููุงุก ุงูุฃููุฑ ุงููุชุงุญูู" ููุชุฃูุฏ' },
    { 'ุงูุชุนูููุงุช': '' },
    { 'ุงูุชุนูููุงุช': '๐ ูุนูููุงุช ุชููุงุฆูุฉ:' },
    { 'ุงูุชุนูููุงุช': 'โข ุงุณู ููู ุงูุฃูุฑ ุณูุชู ูุฑุงุกุชู ุชููุงุฆูุงู ูู ุจูุงูุงุช ููู ุงูุฃูุฑ' },
    { 'ุงูุชุนูููุงุช': 'โข ุฑูู ุงูุฌูุงู ูููู ุฃู ูููู ุฑูู ุงููุฑูุถ ุฃู ุฑูู ููู ุงูุฃูุฑ' },
    { 'ุงูุชุนูููุงุช': 'โข ูุง ุชุชุฑู ุฎุงูุงุช ูุงุฑุบุฉ ูู ุงูุญููู ุงููุทููุจุฉ' },
    { 'ุงูุชุนูููุงุช': '' },
    { 'ุงูุชุนูููุงุช': '๐ก ูุตุงุฆุญ ูุชุฌูุจ ุงูุฃุฎุทุงุก:' },
    { 'ุงูุชุนูููุงุช': 'โข ุชุฃูุฏ ูู ุตุญุฉ ุฃุฑูุงู ุงููููุฉ ูุจู ุงูุงุณุชูุฑุงุฏ' },
    { 'ุงูุชุนูููุงุช': 'โข ุชุฃูุฏ ูู ูุชุงุจุฉ ููุน ุงููุฑุถ ุจุงูุถุจุท ููุง ูู ููุชูุจ' },
    { 'ุงูุชุนูููุงุช': 'โข ูู ุญุงูุฉ ูุฌูุฏ ุฃุฎุทุงุกุ ุณูุชู ุชุญููู ููู ุงูุฃุฎุทุงุก ุชููุงุฆูุงู' }
  ];

  const instructionsWorksheet = XLSX.utils.json_to_sheet(instructionsData);
  instructionsWorksheet['!dir'] = 'rtl';
  instructionsWorksheet['!cols'] = [{ wch: 80 }];

  // ุฅูุดุงุก ูุชุงุจ ุงูุนูู
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, 'ูุงูุจ ุงูุจูุงูุงุช ุงููุฑุถูุฉ');
  XLSX.utils.book_append_sheet(workbook, guardiansWorksheet, 'ุฃูููุงุก ุงูุฃููุฑ ุงููุชุงุญูู');
  XLSX.utils.book_append_sheet(workbook, diseaseTypesWorksheet, 'ุฃููุงุน ุงูุฃูุฑุงุถ');
  XLSX.utils.book_append_sheet(workbook, instructionsWorksheet, 'ุงูุชุนูููุงุช');

  // ุชุนููู ุฎุตุงุฆุต RTL ูููุชุงุจ
  workbook.Props = {
    Title: 'ูุงูุจ ุงูุจูุงูุงุช ุงููุฑุถูุฉ',
    Subject: 'ูุงูุจ ูุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช ุงููุฑุถูุฉ',
    Author: 'ูุธุงู ุงููุณุงุนุฏุงุช - ูุทุงุน ุบุฒุฉ',
    CreatedDate: new Date()
  };

  return workbook;
};

// ุชุตุฏูุฑ ุงูุจูุงูุงุช ุงููุฑุถูุฉ ุฅูู Excel
export const exportMedicalDataToExcel = (medicalData: MedicalData[]) => {
  const exportData = medicalData.map(data => ({
    'ุงุณู ุงููุฑูุถ': data.patientName,
    'ุฑูู ูููุฉ ุงููุฑูุถ': data.patientNationalId,
    'ุฑูู ูููุฉ ููู ุงูุฃูุฑ': data.guardianNationalId,
    'ุงุณู ููู ุงูุฃูุฑ': data.guardianName || '',
    'ููุน ุงููุฑุถ': data.diseaseType,
    'ุฑูู ุงูุฌูุงู': data.phone || '',
    'ููุงุญุธุงุช': data.notes || '',
    'ุชุงุฑูุฎ ุงูุชุณุฌูู': new Date(data.createdAt).toLocaleDateString('ar-EG'),
    'ุขุฎุฑ ุชุญุฏูุซ': new Date(data.updatedAt).toLocaleDateString('ar-EG')
  }));

  const worksheet = XLSX.utils.json_to_sheet(exportData);
  worksheet['!dir'] = 'rtl';
  
  // ุชุนููู ุนุฑุถ ุงูุฃุนูุฏุฉ
  worksheet['!cols'] = [
    { wch: 25 }, // ุงุณู ุงููุฑูุถ
    { wch: 20 }, // ุฑูู ูููุฉ ุงููุฑูุถ
    { wch: 20 }, // ุฑูู ูููุฉ ููู ุงูุฃูุฑ
    { wch: 25 }, // ุงุณู ููู ุงูุฃูุฑ
    { wch: 20 }, // ููุน ุงููุฑุถ
    { wch: 15 }, // ุฑูู ุงูุฌูุงู
    { wch: 30 }, // ููุงุญุธุงุช
    { wch: 15 }, // ุชุงุฑูุฎ ุงูุชุณุฌูู
    { wch: 15 }  // ุขุฎุฑ ุชุญุฏูุซ
  ];

  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, 'ุงูุจูุงูุงุช ุงููุฑุถูุฉ');

  workbook.Props = {
    Title: 'ุงูุจูุงูุงุช ุงููุฑุถูุฉ',
    Subject: 'ุชุตุฏูุฑ ุงูุจูุงูุงุช ุงููุฑุถูุฉ',
    Author: 'ูุธุงู ุงููุณุงุนุฏุงุช - ูุทุงุน ุบุฒุฉ',
    CreatedDate: new Date()
  };

  return workbook;
};

// ูุฑุงุกุฉ ููู Excel ูุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช ุงููุฑุถูุฉ ูุน ุงูุชุญูู ูู ุงูุฃุฎุทุงุก
export const importMedicalDataFromExcel = (file: File, guardians: Guardian[]): Promise<{
  validMedicalData: Partial<MedicalData>[];
  errors: Array<{row: number, field: string, message: string}>;
}> => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    
    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target?.result as ArrayBuffer);
        const workbook = XLSX.read(data, { 
          type: 'array', 
          cellDates: false,
          raw: false
        });
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
          raw: false,
          defval: '',
          blankrows: false
        });

        const validMedicalData: Partial<MedicalData>[] = [];
        const errors: Array<{row: number, field: string, message: string}> = [];

        // ุฃููุงุน ุงูุฃูุฑุงุถ ุงููุชุงุญุฉ
        const diseaseTypes = [
          'ูุฑุถ ูุฒูู',
          'ูุฑุถ ููุจ',
          'ูุฑุถ ุงูุฑุจู',
          'ูุฑุถ ุงูุตุฑุน',
          'ูุฑุถ ุงูุณูุฑู',
          'ูุฑุถ ุงูููู',
          'ูุฑุถ ุงูุถุบุท',
          'ูุฑุถ ุงูุบุฏุฉ ุงูุฏุฑููุฉ',
          'ูุฑุถ ุงููุจุฏ',
          'ูุฑุถ ุงูุณุฑุทุงู',
          'ูุฑุถ ุงูุฌูุงุฒ ุงููุถูู',
          'ูุฑุถ ุงูุฌูุงุฒ ุงูุชููุณู',
          'ูุฑุถ ุงูุนุธุงู',
          'ูุฑุถ ุงูุนููู',
          'ูุฑุถ ุงูุฃุนุตุงุจ',
          'ูุฑุถ ููุณู',
          'ูุฑุถ ุฌูุฏู',
          'ูุฑุถ ุขุฎุฑ'
        ];

        jsonData.forEach((row: any, index: number) => {
          const rowNumber = index + 2;
          const medicalDataItem: Partial<MedicalData> = {};
          let hasErrors = false;

          // ุงุณู ุงููุฑูุถ (ูุทููุจ)
          const patientName = row['ุงุณู ุงููุฑูุถ'] || '';
          if (!patientName || patientName.toString().trim() === '') {
            errors.push({row: rowNumber, field: 'ุงุณู ุงููุฑูุถ', message: 'ุงุณู ุงููุฑูุถ ูุทููุจ'});
            hasErrors = true;
          } else {
            medicalDataItem.patientName = patientName.toString().trim();
          }

          // ุฑูู ูููุฉ ุงููุฑูุถ (ูุทููุจ)
          const patientNationalId = row['ุฑูู ูููุฉ ุงููุฑูุถ'] || '';
          if (!patientNationalId || patientNationalId.toString().trim() === '') {
            errors.push({row: rowNumber, field: 'ุฑูู ูููุฉ ุงููุฑูุถ', message: 'ุฑูู ูููุฉ ุงููุฑูุถ ูุทููุจ'});
            hasErrors = true;
          } else {
            medicalDataItem.patientNationalId = patientNationalId.toString().trim();
          }

          // ุฑูู ูููุฉ ููู ุงูุฃูุฑ (ูุทููุจ)
          const guardianNationalId = row['ุฑูู ูููุฉ ููู ุงูุฃูุฑ'] || '';
          if (!guardianNationalId || guardianNationalId.toString().trim() === '') {
            errors.push({row: rowNumber, field: 'ุฑูู ูููุฉ ููู ุงูุฃูุฑ', message: 'ุฑูู ูููุฉ ููู ุงูุฃูุฑ ูุทููุจ'});
            hasErrors = true;
          } else {
            const guardianNationalIdStr = guardianNationalId.toString().trim();
            medicalDataItem.guardianNationalId = guardianNationalIdStr;

            // ุงูุจุญุซ ุนู ููู ุงูุฃูุฑ
            const guardian = guardians.find(g => g.nationalId === guardianNationalIdStr);
            if (guardian) {
              medicalDataItem.guardianName = guardian.name;
              
              // ุงุณุชุฎุฏุงู ุฑูู ูุงุชู ููู ุงูุฃูุฑ ุฅุฐุง ูู ูุชู ุชูููุฑ ุฑูู ูุงุชู ุขุฎุฑ
              if (!row['ุฑูู ุงูุฌูุงู'] || row['ุฑูู ุงูุฌูุงู'].toString().trim() === '') {
                medicalDataItem.phone = guardian.phone;
              }
            } else {
              errors.push({
                row: rowNumber, 
                field: 'ุฑูู ูููุฉ ููู ุงูุฃูุฑ', 
                message: `ูู ูุชู ุงูุนุซูุฑ ุนูู ููู ุฃูุฑ ุจุฑูู ุงููููุฉ: ${guardianNationalIdStr}`
              });
              hasErrors = true;
            }
          }

          // ููุน ุงููุฑุถ (ูุทููุจ)
          const diseaseType = row['ููุน ุงููุฑุถ'] || '';
          if (!diseaseType || diseaseType.toString().trim() === '') {
            errors.push({row: rowNumber, field: 'ููุน ุงููุฑุถ', message: 'ููุน ุงููุฑุถ ูุทููุจ'});
            hasErrors = true;
          } else {
            const diseaseTypeStr = diseaseType.toString().trim();
            if (diseaseTypes.includes(diseaseTypeStr)) {
              medicalDataItem.diseaseType = diseaseTypeStr;
            } else {
              errors.push({
                row: rowNumber, 
                field: 'ููุน ุงููุฑุถ', 
                message: `ููุน ุงููุฑุถ ุบูุฑ ุตุญูุญ: "${diseaseTypeStr}". ุงูุฃููุงุน ุงููุชุงุญุฉ: ${diseaseTypes.join(', ')}`
              });
              hasErrors = true;
            }
          }

          // ุฑูู ุงูุฌูุงู (ูุทููุจ)
          const phone = row['ุฑูู ุงูุฌูุงู'] || '';
          if (phone && phone.toString().trim() !== '') {
            medicalDataItem.phone = phone.toString().trim();
          } else if (!medicalDataItem.phone) {
            errors.push({row: rowNumber, field: 'ุฑูู ุงูุฌูุงู', message: 'ุฑูู ุงูุฌูุงู ูุทููุจ'});
            hasErrors = true;
          }

          // ุงูููุงุญุธุงุช (ุงุฎุชูุงุฑู)
          medicalDataItem.notes = (row['ููุงุญุธุงุช'] || '').toString().trim();

          if (!hasErrors) {
            validMedicalData.push(medicalDataItem);
          }
        });

        resolve({ validMedicalData, errors });
      } catch (error) {
        console.error('ุฎุทุฃ ูู ูุฑุงุกุฉ ููู Excel:', error);
        reject(new Error(`ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูููู: ${error instanceof Error ? error.message : 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'}. ุชุฃูุฏ ูู ุฃู ุงูููู ุจุตูุบุฉ Excel ุตุญูุญุฉ.`));
      }
    };

    reader.onerror = () => {
      reject(new Error('ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูููู. ุชุฃูุฏ ูู ุฃู ุงูููู ุบูุฑ ุชุงูู.'));
    };

    reader.readAsArrayBuffer(file);
  });
};

// ุชุตุฏูุฑ ููู ุงูุฃุฎุทุงุก
export const exportMedicalDataErrorsToExcel = (errors: Array<{row: number, field: string, message: string}>) => {
  const errorData = errors.map((error, index) => ({
    'ุฑูู ุงูุฎุทุฃ': index + 1,
    'ุฑูู ุงูุตู ูู ุงูููู': error.row,
    'ุงูุญูู ุงููุชุฃุซุฑ': error.field,
    'ูุตู ุงููุดููุฉ': error.message,
    'ููุน ุงูุฎุทุฃ': error.field === 'ููุน ุงููุฑุถ' ? 'ุฎุทุฃ ูู ููุน ุงููุฑุถ' : 
                  error.field.includes('ููู ุงูุฃูุฑ') ? 'ุฎุทุฃ ูู ุจูุงูุงุช ููู ุงูุฃูุฑ' : 'ุฎุทุฃ ูู ุงูุจูุงูุงุช'
  }));

  const worksheet = XLSX.utils.json_to_sheet(errorData);
  worksheet['!dir'] = 'rtl';
  worksheet['!cols'] = [
    { wch: 12 }, // ุฑูู ุงูุฎุทุฃ
    { wch: 15 }, // ุฑูู ุงูุตู ูู ุงูููู
    { wch: 20 }, // ุงูุญูู ุงููุชุฃุซุฑ
    { wch: 60 }, // ูุตู ุงููุดููุฉ
    { wch: 20 }  // ููุน ุงูุฎุทุฃ
  ];

  // ุฅุถุงูุฉ ูุฑูุฉ ุญููู ููุฃุฎุทุงุก ุงูุดุงุฆุนุฉ
  const solutionsData = [
    { 'ุงูุญููู': '๐ง ุญููู ููุฃุฎุทุงุก ุงูุดุงุฆุนุฉ:' },
    { 'ุงูุญููู': '' },
    { 'ุงูุญููู': '๐ฅ ูุดุงูู ููุน ุงููุฑุถ:' },
    { 'ุงูุญููู': 'โข ุงุณุชุฎุฏู ุงูุฃููุงุน ุงููุญุฏุฏุฉ ููุท ูู ูุฑูุฉ "ุฃููุงุน ุงูุฃูุฑุงุถ"' },
    { 'ุงูุญููู': 'โข ุชุฃูุฏ ูู ูุชุงุจุฉ ุงูููุน ุจุงูุถุจุท ููุง ูู ููุชูุจ' },
    { 'ุงูุญููู': 'โข ูุง ุชุถุน ูุณุงูุงุช ุฅุถุงููุฉ ูุจู ุฃู ุจุนุฏ ุงูููุน' },
    { 'ุงูุญููู': '' },
    { 'ุงูุญููู': '๐จโ๐ฉโ๐งโ๐ฆ ูุดุงูู ููู ุงูุฃูุฑ:' },
    { 'ุงูุญููู': 'โข ุชุฃูุฏ ูู ูุฌูุฏ ููู ุงูุฃูุฑ ูู ุงููุธุงู ุฃููุงู' },
    { 'ุงูุญููู': 'โข ุฑุงุฌุน ูุฑูุฉ "ุฃูููุงุก ุงูุฃููุฑ ุงููุชุงุญูู" ููุชุฃูุฏ' },
    { 'ุงูุญููู': 'โข ุชุฃูุฏ ูู ุตุญุฉ ุฑูู ุงููููุฉ (ุจุฏูู ูุณุงูุงุช ุฃู ุฑููุฒ)' },
    { 'ุงูุญููู': '' },
    { 'ุงูุญููู': '๐ฑ ูุดุงูู ุฑูู ุงูุฌูุงู:' },
    { 'ุงูุญููู': 'โข ุชุฃูุฏ ูู ุฅุฏุฎุงู ุฑูู ุฌูุงู ุตุญูุญ' },
    { 'ุงูุญููู': 'โข ูููู ุงูุงุณุชูุงุฏุฉ ูู ุจูุงูุงุช ุฃูููุงุก ุงูุฃููุฑ ุงูููุฌูุฏูู' },
    { 'ุงูุญููู': 'โข ุฅุฐุง ูุงู ุงููุฑูุถ ูุณุฌูุงู ูููู ุฃูุฑุ ุงุณุชุฎุฏู ููุณ ุฑูู ุงููููุฉ' },
    { 'ุงูุญููู': '' },
    { 'ุงูุญููู': '๐ ูุตุงุฆุญ ุนุงูุฉ:' },
    { 'ุงูุญููู': 'โข ูุง ุชุชุฑู ุฃู ุญูู ูุทููุจ ูุงุฑุบุงู' },
    { 'ุงูุญููู': 'โข ุงุณุชุฎุฏู ุฃุฑูุงู ุงููููุฉ ููุง ูู ุจุฏูู ุชูุณูู' },
    { 'ุงูุญููู': 'โข ูู ุญุงูุฉ ุงุณุชูุฑุงุฑ ุงููุดุงููุ ุฑุงุฌุน ูุฑูุฉ ุงูุชุนูููุงุช ูู ุงููุงูุจ' }
  ];

  const solutionsWorksheet = XLSX.utils.json_to_sheet(solutionsData);
  solutionsWorksheet['!dir'] = 'rtl';
  solutionsWorksheet['!cols'] = [{ wch: 80 }];

  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, 'ุฃุฎุทุงุก ุงูุงุณุชูุฑุงุฏ');
  XLSX.utils.book_append_sheet(workbook, solutionsWorksheet, 'ุงูุญููู ูุงููุตุงุฆุญ');

  workbook.Props = {
    Title: 'ุฃุฎุทุงุก ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช ุงููุฑุถูุฉ',
    Subject: 'ุชูุฑูุฑ ููุตู ููุฃุฎุทุงุก ูู ุนูููุฉ ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช ุงููุฑุถูุฉ ูุน ุงูุญููู',
    Author: 'ูุธุงู ุงููุณุงุนุฏุงุช - ูุทุงุน ุบุฒุฉ',
    CreatedDate: new Date()
  };

  return workbook;
};

// ุชุญููู ููู Excel
export const downloadExcelFile = (workbook: XLSX.WorkBook, filename: string) => {
  const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
  const data = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  
  const link = document.createElement('a');
  link.href = URL.createObjectURL(data);
  link.download = `${filename}.xlsx`;
  link.click();
  
  // ุชูุธูู ุงูุฐุงูุฑุฉ
  URL.revokeObjectURL(link.href);
};